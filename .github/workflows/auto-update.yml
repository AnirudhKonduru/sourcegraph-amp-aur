name: Auto Update AUR Package

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl

      - name: Install makepkg
        run: |
          # Install makepkg for .SRCINFO generation
          sudo apt-get install -y fakeroot

      - name: Check and update package
        id: update
        run: |
          # Make script executable
          chmod +x update-package.sh
          
          # Run update script in CI mode
          set +e  # Don't exit on script failure
          ./update-package.sh --ci
          exit_code=$?
          set -e
          
          if [ $exit_code -eq 0 ]; then
            # Script succeeded, update was made
            updated_ver=$(awk -F'=' '/^_npmver=/ {print $2}' PKGBUILD | cut -d' ' -f1)
            echo "updated_version=$updated_ver" >> $GITHUB_OUTPUT
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            # Script exited (likely no update needed)
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.update.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update @sourcegraph/amp to ${{ steps.update.outputs.updated_version }}"
          title: "Update @sourcegraph/amp to ${{ steps.update.outputs.updated_version }}"
          body: |
            ðŸ¤– **Automated package update**
            
            Updates `@sourcegraph/amp` to `${{ steps.update.outputs.updated_version }}`
            
            **Changes:**
            - Updated `_npmver` to `${{ steps.update.outputs.updated_version }}`
            - Reset `pkgrel` to `1`
            - Updated checksums
            - Regenerated `.SRCINFO`
            
            Auto-generated by GitHub Actions ðŸš€
          branch: update/amp-${{ steps.update.outputs.updated_version }}
          delete-branch: true
